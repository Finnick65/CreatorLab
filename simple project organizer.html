<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CreatorLab Project Organizer</title>
    <!-- Google Fonts - Black Ops One -->
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Black Ops One font and basic body styling */
        body {
            font-family: 'Black Ops One', cursive; /* Apply Black Ops One font */
            background-color: #e0f2fe; /* Light blue background for the body (Tailwind bg-blue-50 equivalent) */
        }
        /* Hide scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            display: none;
        }
        html {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Overlay for confirmation modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        /* Custom style for project cards for hover effect and more rounded corners */
        .project-card {
            border-radius: 1.5rem; /* More rounded corners */
            transition: all 0.3s ease-in-out; /* Smooth transition for hover effects */
            cursor: default; /* Change cursor back to default since card itself isn't clickable for edit anymore */
        }

        .project-card:hover {
            transform: translateY(-5px) scale(1.02); /* Lifts and slightly scales up */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2); /* More prominent shadow */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center py-10 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl w-full bg-blue-100 p-8 rounded-lg shadow-xl border border-blue-200">
        <!-- Header with Title and New Project Button -->
        <h1 class="text-3xl font-bold text-left text-blue-800 mb-4 flex flex-col sm:flex-row justify-between items-center">
            CreatorLab
            <div class="flex flex-wrap gap-2 justify-center sm:justify-end mt-4 sm:mt-0">
                <button id="show-add-btn"
                        class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    + Create New Project
                </button>
            </div>
        </h1>

        <!-- Filters Section with Utilities on Left and Create Folder on Right -->
        <div class="flex flex-col sm:flex-row flex-wrap gap-4 mb-6">
            <!-- Row for Import/Export/Select buttons on Left and Create Folder on Right -->
            <div class="w-full flex justify-between items-center flex-wrap gap-2">
                <div class="flex flex-wrap gap-2 justify-start">
                    <button id="toggle-selection-btn"
                            class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-blue-800 bg-blue-200 hover:bg-blue-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                        Select Projects
                    </button>
                    <button id="export-projects-btn"
                            class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-blue-800 bg-blue-300 hover:bg-blue-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                        Export All Projects
                    </button>
                    <input type="file" id="import-projects-input" accept=".json" class="hidden">
                    <button id="import-projects-btn"
                            class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-blue-800 bg-blue-300 hover:bg-blue-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                        Import Projects
                    </button>
                </div>
                <button id="create-folder-btn"
                        class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out">
                    + Create Folder
                </button>
            </div>

            <!-- Title Search -->
            <div class="w-full sm:w-auto flex-grow">
                <label for="title-search-input" class="block text-sm font-medium text-blue-700 mb-1">Search Title</label>
                <input type="text" id="title-search-input" placeholder="Search project titles..."
                       class="block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <!-- Folder Navigation -->
            <div class="w-full sm:w-auto flex-grow">
                <label for="folder-filter-select" class="block text-sm font-medium text-blue-700 mb-1">Filter by Folder</label>
                <div class="relative">
                    <select id="folder-filter-select"
                            class="block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8">
                        <!-- Options populated by JS -->
                    </select>
                    <!-- Dropdown arrow icon -->
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Status Filter Dropdown -->
            <div class="w-full sm:w-auto flex-grow">
                <label for="status-filter-select" class="block text-sm font-medium text-blue-700 mb-1">Filter by Status</label>
                <div class="relative">
                    <select id="status-filter-select"
                            class="block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8">
                        <!-- Options populated by JS -->
                    </select>
                    <!-- Dropdown arrow icon -->
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Focus Area Filter Dropdown -->
            <div class="w-full sm:w-auto flex-grow">
                <label for="focus-area-filter-select" class="block text-sm font-medium text-blue-700 mb-1">Filter by Focus Area</label>
                <div class="relative">
                    <select id="focus-area-filter-select"
                            class="block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8">
                        <!-- Options populated by JS -->
                    </select>
                    <!-- Dropdown arrow icon -->
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>

            <!-- New Difficulty Rating Filter Dropdown -->
            <div class="w-full sm:w-auto flex-grow">
                <label for="difficulty-rating-filter-select" class="block text-sm font-medium text-blue-700 mb-1">Filter by Difficulty</label>
                <div class="relative">
                    <select id="difficulty-rating-filter-select"
                            class="block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8">
                        <!-- Options populated by JS -->
                    </select>
                    <!-- Dropdown arrow icon -->
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>

            <!-- New Complexity Filter Dropdown -->
            <div class="w-full sm:w-auto flex-grow">
                <label for="complexity-filter-select" class="block text-sm font-medium text-blue-700 mb-1">Filter by Complexity</label>
                <div class="relative">
                    <select id="complexity-filter-select"
                            class="block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8">
                        <!-- Options populated by JS -->
                    </select>
                    <!-- Dropdown arrow icon -->
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selection Mode Actions (Hidden by default) -->
        <div id="selection-actions" class="flex flex-wrap justify-start items-center gap-2 mb-4 hidden">
            <span class="text-blue-700 text-sm font-semibold">Selected: <span id="selected-count">0</span></span>
            <button id="select-all-btn"
                    class="py-1 px-3 rounded-md shadow-sm text-xs font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                Select All
            </button>
            <button id="deselect-all-btn"
                    class="py-1 px-3 rounded-md shadow-sm text-xs font-medium text-blue-600 bg-white hover:bg-blue-50 border border-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                Deselect All
            </button>
        </div>


        <!-- Project List Page -->
        <div id="project-list-page" class="page">
            <div class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-100 shadow-sm">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">Your Projects</h2>
                <div id="project-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="col-span-full text-blue-500 text-center" id="no-projects-message">No projects added yet. Add one above!</p>
                </div>
            </div>
        </div>

        <!-- Add Project Page -->
        <div id="add-project-page" class="page hidden">
            <form id="add-project-form" class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-100 shadow-sm">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">Add New Project</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Project Name -->
                    <div>
                        <label for="add-project-name" class="block text-sm font-medium text-blue-700 mb-1">Project Name</label>
                        <input type="text" id="add-project-name" name="projectName" required
                               class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>

                    <!-- Due Date -->
                    <div>
                        <label for="add-due-date" class="block text-sm font-medium text-blue-700 mb-1">Due Date</label>
                        <input type="date" id="add-due-date" name="dueDate"
                               class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>

                    <!-- Project Overview -->
                    <div class="md:col-span-2">
                        <label for="add-project-overview" class="block text-sm font-medium text-blue-700 mb-1">Overview</label>
                        <textarea id="add-project-overview" name="projectOverview" rows="3"
                                  class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>

                    <!-- Project Description -->
                    <div class="md:col-span-2">
                        <label for="add-project-description" class="block text-sm font-medium text-blue-700 mb-1">Description</label>
                        <textarea id="add-project-description" name="projectDescription" rows="3"
                                  class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>

                    <!-- Status -->
                    <div>
                        <label for="add-project-status" class="block text-sm font-medium text-blue-700 mb-1">Status</label>
                        <select id="add-project-status" name="projectStatus" required
                                class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="On Hold">On Hold</option>
                            <!-- Dynamic options will be added here by JS -->
                        </select>
                    </div>

                    <!-- Folder Dropdown for Add Project -->
                    <div>
                        <label for="add-project-folder" class="block text-sm font-medium text-blue-700 mb-1">Folder</label>
                        <select id="add-project-folder" name="projectFolder"
                                class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <!-- Options will be dynamically populated by JS -->
                        </select>
                    </div>

                    <!-- Focus Area Dropdown for Add Project -->
                    <div>
                        <label for="add-focus-area" class="block text-sm font-medium text-blue-700 mb-1">Focus Area</label>
                        <select id="add-focus-area" name="focusArea"
                                class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Select Focus Area</option>
                            <option value="Vehicles">Vehicles</option>
                            <option value="Guitar">Guitar</option>
                            <option value="Airsoft">Airsoft</option>
                            <option value="Physics">Physics</option>
                            <option value="Aerospace Engineering">Aerospace Engineering</option>
                            <!-- Dynamic options will be added here by JS -->
                        </select>
                    </div>

                    <!-- Difficulty Rating Dropdown for Add Project -->
                    <div>
                        <label for="add-difficulty-rating" class="block text-sm font-medium text-blue-700 mb-1">Difficulty Rating</label>
                        <select id="add-difficulty-rating" name="difficultyRating"
                                class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Select Difficulty</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <!-- Dynamic options will be added here by JS -->
                        </select>
                    </div>

                    <!-- Complexity Dropdown for Add Project -->
                    <div>
                        <label for="add-complexity" class="block text-sm font-medium text-blue-700 mb-1">Complexity</label>
                        <select id="add-complexity" name="complexity"
                                class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Select Complexity</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <!-- Dynamic options will be added here by JS -->
                        </select>
                    </div>

                    <!-- Code Notes -->
                    <div class="md:col-span-2">
                        <label for="add-code-notes" class="block text-sm font-medium text-blue-700 mb-1">Code Notes</label>
                        <textarea id="add-code-notes" name="codeNotes" rows="4"
                                  class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>

                    <!-- CAD Notes -->
                    <div class="md:col-span-2">
                        <label for="add-cad-notes" class="block text-sm font-medium text-blue-700 mb-1">CAD Notes</label>
                        <textarea id="add-cad-notes" name="cadNotes" rows="4"
                                  class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>

                    <!-- Material Notes for Add Project -->
                    <div class="md:col-span-2">
                        <label for="add-material-notes" class="block text-sm font-medium text-blue-700 mb-1">Material Notes</label>
                        <textarea id="add-material-notes" name="materialNotes" rows="4"
                                  class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>
                </div>

                <!-- Project Costs Section (for Add Project Page) -->
                <div class="mt-8 p-6 bg-blue-100 rounded-lg border border-blue-200 shadow-inner">
                    <h3 class="text-xl font-semibold text-blue-800 mb-4">Project Costs</h3>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="md:col-span-2">
                            <label for="add-cost-description" class="block text-sm font-medium text-blue-700 mb-1">Item Description (Optional)</label>
                            <input type="text" id="add-cost-description" placeholder="e.g. Paint, Sensors"
                                   class="mt-1 block w-full px-3 py-1.5 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="add-cost-amount" class="block text-sm font-medium text-blue-700 mb-1">Amount ($)</label>
                            <input type="number" id="add-cost-amount" min="0" step="0.01" value="0.00"
                                   class="mt-1 block w-full px-3 py-1.5 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                    <button type="button" id="add-add-cost-btn"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                        Add Cost Item
                    </button>

                    <div id="add-costs-list-display" class="mt-6 border-t border-blue-200 pt-4">
                        <p class="text-blue-600 text-center" id="add-no-costs-message">No cost items added yet.</p>
                    </div>

                    <div class="mt-4 text-right text-lg font-bold text-blue-900">
                        Total Project Cost: <span id="add-total-project-cost">$0.00</span>
                    </div>
                </div>

                <!-- Add Project Button -->
                <button type="submit"
                        class="mt-6 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    Add Project
                </button>
                <button type="button" id="back-to-list-from-add"
                        class="mt-3 w-full flex justify-center py-2 px-4 border border-blue-600 rounded-md shadow-sm text-sm font-medium text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    Back to Projects
                </button>
            </form>
        </div>

        <!-- Edit Project Page -->
        <div id="edit-project-page" class="page hidden">
            <form id="edit-project-form" class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-100 shadow-sm">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">Edit Project</h2>
                <!-- Hidden input to store the index of the project being edited -->
                <input type="hidden" id="edit-project-index">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Project Name -->
                    <div>
                        <label for="edit-project-name" class="block text-sm font-medium text-blue-700 mb-1">Project Name</label>
                        <input type="text" id="edit-project-name" name="projectName" required
                               class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>

                    <!-- Due Date -->
                    <div>
                        <label for="edit-due-date" class="block text-sm font-medium text-blue-700 mb-1">Due Date</label>
                        <input type="date" id="edit-due-date" name="dueDate"
                               class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>

                    <!-- Project Overview -->
                    <div class="md:col-span-2">
                        <label for="edit-project-overview" class="block text-sm font-medium text-blue-700 mb-1">Overview</label>
                        <textarea id="edit-project-overview" name="projectOverview" rows="3"
                                  class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>

                    <!-- Project Description -->
                    <div class="md:col-span-2">
                        <label for="edit-project-description" class="block text-sm font-medium text-blue-700 mb-1">Description</label>
                        <textarea id="edit-project-description" name="projectDescription" rows="3"
                                  class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>

                    <!-- Status -->
                    <div>
                        <label for="edit-project-status" class="block text-sm font-medium text-blue-700 mb-1">Status</label>
                        <select id="edit-project-status" name="projectStatus" required
                                class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="On Hold">On Hold</option>
                            <!-- Dynamic options will be added here by JS -->
                        </select>
                    </div>

                    <!-- Folder Dropdown for Edit Project -->
                    <div>
                        <label for="edit-project-folder" class="block text-sm font-medium text-blue-700 mb-1">Folder</label>
                        <select id="edit-project-folder" name="projectFolder"
                                class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <!-- Options will be dynamically populated by JS -->
                        </select>
                    </div>

                    <!-- Focus Area Dropdown for Edit Project -->
                    <div>
                        <label for="edit-focus-area" class="block text-sm font-medium text-blue-700 mb-1">Focus Area</label>
                        <select id="edit-focus-area" name="focusArea"
                                class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Select Focus Area</option>
                            <option value="Vehicles">Vehicles</option>
                            <option value="Guitar">Guitar</option>
                            <option value="Airsoft">Airsoft</option>
                            <option value="Physics">Physics</option>
                            <option value="Aerospace Engineering">Aerospace Engineering</option>
                            <!-- Dynamic options will be added here by JS -->
                        </select>
                    </div>

                    <!-- Difficulty Rating Dropdown for Edit Project -->
                    <div>
                        <label for="edit-difficulty-rating" class="block text-sm font-medium text-blue-700 mb-1">Difficulty Rating</label>
                        <select id="edit-difficulty-rating" name="difficultyRating"
                                class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Select Difficulty</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <!-- Dynamic options will be added here by JS -->
                        </select>
                    </div>

                    <!-- Complexity Dropdown for Edit Project -->
                    <div>
                        <label for="edit-complexity" class="block text-sm font-medium text-blue-700 mb-1">Complexity</label>
                        <select id="edit-complexity" name="complexity"
                                class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Select Complexity</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <!-- Dynamic options will be added here by JS -->
                        </select>
                    </div>

                    <!-- Code Notes for Edit -->
                    <div class="md:col-span-2">
                        <label for="edit-code-notes" class="block text-sm font-medium text-blue-700 mb-1">Code Notes</label>
                        <textarea id="edit-code-notes" name="codeNotes" rows="4"
                                  class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>

                    <!-- CAD Notes for Edit -->
                    <div class="md:col-span-2">
                        <label for="edit-cad-notes" class="block text-sm font-medium text-blue-700 mb-1">CAD Notes</label>
                        <textarea id="edit-cad-notes" name="cadNotes" rows="4"
                                  class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>

                    <!-- Material Notes for Edit Project -->
                    <div class="md:col-span-2">
                        <label for="edit-material-notes" class="block text-sm font-medium text-blue-700 mb-1">Material Notes</label>
                        <textarea id="edit-material-notes" name="materialNotes" rows="4"
                                  class="mt-1 block w-full px-4 py-2 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>
                </div>

                <!-- Project Costs Section (for Edit Project Page) -->
                <div class="mt-8 p-6 bg-blue-100 rounded-lg border border-blue-200 shadow-inner">
                    <h3 class="text-xl font-semibold text-blue-800 mb-4">Project Costs</h3>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="md:col-span-2">
                            <label for="edit-cost-description" class="block text-sm font-medium text-blue-700 mb-1">Item Description (Optional)</label>
                            <input type="text" id="edit-cost-description" placeholder="e.g. Paint, Sensors"
                                   class="mt-1 block w-full px-3 py-1.5 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="edit-cost-amount" class="block text-sm font-medium text-blue-700 mb-1">Amount ($)</label>
                            <input type="number" id="edit-cost-amount" min="0" step="0.01" value="0.00"
                                   class="mt-1 block w-full px-3 py-1.5 border border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                    <button type="button" id="edit-add-cost-btn"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                        Add Cost Item
                    </button>

                    <div id="edit-costs-list-display" class="mt-6 border-t border-blue-200 pt-4">
                        <p class="text-blue-600 text-center" id="edit-no-costs-message">No cost items added yet.</p>
                    </div>

                    <div class="mt-4 text-right text-lg font-bold text-blue-900">
                        Total Project Cost: <span id="edit-total-project-cost">$0.00</span>
                    </div>
                </div>


                <button type="submit"
                        class="mt-6 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    Save Changes
                </button>
                <button type="button" id="back-to-list-from-edit"
                        class="mt-3 w-full flex justify-center py-2 px-4 border border-blue-600 rounded-md shadow-sm text-sm font-medium text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    Back to Projects
                </button>
            </form>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content bg-blue-50 border border-blue-100">
            <p class="text-xl font-bold text-blue-800 mb-6">Are you sure you want to delete this project?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-delete-btn"
                        class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                    Yes, Delete
                </button>
                <button id="cancel-delete-btn"
                        class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-blue-600 bg-white hover:bg-blue-50 border border-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    No, Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="create-folder-modal" class="modal-overlay hidden">
        <div class="modal-content bg-purple-50 border border-purple-100">
            <h3 class="text-xl font-bold text-purple-800 mb-4">Create New Folder</h3>
            <input type="text" id="new-folder-name-input" placeholder="Enter folder name"
                   class="mt-1 block w-full px-4 py-2 border border-purple-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm mb-4">
            <div class="flex justify-center space-x-4">
                <button id="confirm-create-folder-btn"
                        class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out">
                    Create Folder
                </button>
                <button id="cancel-create-folder-btn"
                        class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-purple-600 bg-white hover:bg-purple-50 border border-purple-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="delete-folder-modal" class="modal-overlay hidden">
        <div class="modal-content bg-red-50 border border-red-100">
            <p class="text-xl font-bold text-red-800 mb-6">Are you sure you want to delete folder "<span id="folder-to-delete-name" class="font-extrabold"></span>"?</p>
            <p class="text-sm text-red-700 mb-6">All projects in this folder will be moved to "Uncategorized".</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-delete-folder-btn"
                        class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                    Yes, Delete Folder
                </button>
                <button id="cancel-delete-folder-btn"
                        class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-red-600 bg-white hover:bg-red-50 border border-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                    No, Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="message-modal" class="modal-overlay hidden">
        <div class="modal-content bg-blue-50 border border-blue-100">
            <p id="message-modal-text" class="text-xl font-bold text-blue-800 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="message-modal-confirm-btn"
                        class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out hidden">
                    Confirm
                </button>
                <button id="message-modal-cancel-btn"
                        class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-blue-600 bg-white hover:bg-blue-50 border border-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    Okay
                </button>
            </div>
        </div>
    </div>


    <script>
        // Array to hold all project objects
        let projects = [];
        // Array to hold folder names
        let folders = ['All Projects', 'Uncategorized'];
        // Variable to temporarily store the index of the project to be deleted
        let projectIndexToDelete = -1;
        // Variable to store the index of the project currently being edited
        let currentEditProjectIndex = -1;

        // Filter states
        let currentFolderFilter = 'All Projects';
        let currentStatusFilter = 'All Statuses';
        let currentFocusAreaFilter = 'All Focus Areas';
        let currentDifficultyFilter = 'All Difficulties';
        let currentComplexityFilter = 'All Complexities';
        let currentTitleSearch = '';

        // Variable to store the name of the folder currently being considered for deletion
        let folderToDeleteName = '';

        // Temporary array to store costs for a new project before it's saved
        let tempNewProjectCosts = [];

        // New state for selection mode
        let isSelectionMode = false;
        let selectedProjectIds = new Set(); // Using Set for efficient ID lookups

        // Get DOM elements for different pages/forms
        const projectListPage = document.getElementById('project-list-page');
        const addProjectPage = document.getElementById('add-project-page');
        const editProjectPage = document.getElementById('edit-project-page');

        const showAddBtn = document.getElementById('show-add-btn');
        const createFolderBtn = document.getElementById('create-folder-btn');

        // Filter elements
        const titleSearchInput = document.getElementById('title-search-input');
        const folderFilterSelect = document.getElementById('folder-filter-select');
        const statusFilterSelect = document.getElementById('status-filter-select');
        const focusAreaFilterSelect = document.getElementById('focus-area-filter-select');
        const difficultyRatingFilterSelect = document.getElementById('difficulty-rating-filter-select');
        const complexityFilterSelect = document.getElementById('complexity-filter-select');


        // Add Project Form elements
        const addProjectForm = document.getElementById('add-project-form');
        const addProjectNameInput = document.getElementById('add-project-name');
        const addProjectOverviewInput = document.getElementById('add-project-overview');
        const addProjectDescriptionInput = document.getElementById('add-project-description');
        const addDueDateInput = document.getElementById('add-due-date');
        const addProjectStatusInput = document.getElementById('add-project-status');
        const addProjectFolderSelect = document.getElementById('add-project-folder');
        const addCodeNotesInput = document.getElementById('add-code-notes');
        const addCadNotesInput = document.getElementById('add-cad-notes');
        const addMaterialNotesInput = document.getElementById('add-material-notes');
        const addFocusAreaInput = document.getElementById('add-focus-area');
        const addDifficultyRatingInput = document.getElementById('add-difficulty-rating');
        const addComplexityInput = document.getElementById('add-complexity');
        const backToListFromAddBtn = document.getElementById('back-to-list-from-add');

        // Add Project Costs elements
        const addCostDescriptionInput = document.getElementById('add-cost-description');
        const addCostAmountInput = document.getElementById('add-cost-amount');
        const addAddCostBtn = document.getElementById('add-add-cost-btn');
        const addCostsListDisplay = document.getElementById('add-costs-list-display');
        const addNoCostsMessage = document.getElementById('add-no-costs-message');
        const addTotalProjectCostSpan = document.getElementById('add-total-project-cost');


        // Edit Project Form elements
        const editProjectForm = document.getElementById('edit-project-form');
        const editProjectIndexInput = document.getElementById('edit-project-index');
        const editProjectNameInput = document.getElementById('edit-project-name');
        const editProjectOverviewInput = document.getElementById('edit-project-overview');
        const editProjectDescriptionInput = document.getElementById('edit-project-description');
        const editDueDateInput = document.getElementById('edit-due-date');
        const editProjectStatusInput = document.getElementById('edit-project-status');
        const editProjectFolderSelect = document.getElementById('edit-project-folder');
        const editCodeNotesInput = document.getElementById('edit-code-notes');
        const editCadNotesInput = document.getElementById('edit-cad-notes');
        const editMaterialNotesInput = document.getElementById('edit-material-notes');
        const editFocusAreaInput = document.getElementById('edit-focus-area');
        const editDifficultyRatingInput = document.getElementById('edit-difficulty-rating');
        const editComplexityInput = document.getElementById('edit-complexity');
        const backToListFromEditBtn = document.getElementById('back-to-list-from-edit');

        // Edit Project Costs elements
        const editCostDescriptionInput = document.getElementById('edit-cost-description');
        const editCostAmountInput = document.getElementById('edit-cost-amount');
        const editAddCostBtn = document.getElementById('edit-add-cost-btn');
        const editCostsListDisplay = document.getElementById('edit-costs-list-display');
        const editNoCostsMessage = document.getElementById('edit-no-costs-message');
        const editTotalProjectCostSpan = document.getElementById('edit-total-project-cost');


        // Project List elements
        const projectListDiv = document.getElementById('project-list');
        const noProjectsMessage = document.getElementById('no-projects-message');

        // Confirmation Modal elements (for project deletion)
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

        // Create Folder Modal elements
        const createFolderModal = document.getElementById('create-folder-modal');
        const newFolderNameInput = document.getElementById('new-folder-name-input');
        const confirmCreateFolderBtn = document.getElementById('confirm-create-folder-btn');
        const cancelCreateFolderBtn = document.getElementById('cancel-create-folder-btn');

        // Delete Folder Confirmation Modal elements
        const deleteFolderModal = document.getElementById('delete-folder-modal');
        const folderToDeleteNameSpan = document.getElementById('folder-to-delete-name');
        const confirmDeleteFolderBtn = document.getElementById('confirm-delete-folder-btn');
        const cancelDeleteFolderBtn = document.getElementById('cancel-delete-folder-btn');

        // General Purpose Message Modal (for import confirmation)
        const messageModal = document.getElementById('message-modal');
        const messageModalText = document.getElementById('message-modal-text');
        const messageModalConfirmBtn = document.getElementById('message-modal-confirm-btn');
        const messageModalCancelBtn = document.getElementById('message-modal-cancel-btn');


        // Import/Export and Selection buttons
        const toggleSelectionBtn = document.getElementById('toggle-selection-btn');
        const selectionActionsDiv = document.getElementById('selection-actions');
        const selectedCountSpan = document.getElementById('selected-count');
        const selectAllBtn = document.getElementById('select-all-btn');
        const deselectAllBtn = document.getElementById('deselect-all-btn');
        const exportProjectsBtn = document.getElementById('export-projects-btn');
        const importProjectsBtn = document.getElementById('import-projects-btn');
        const importProjectsInput = document.getElementById('import-projects-input');


        /**
         * Controls which "page" (div) is visible.
         * @param {string} pageId - The ID of the page to show.
         */
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
        }

        /**
         * Shows the confirmation modal for project deletion.
         * @param {number} index - The index of the project to confirm deletion for.
         */
        function showConfirmationModal(index) {
            projectIndexToDelete = index;
            confirmationModal.classList.remove('hidden');
        }

        /**
         * Hides the confirmation modal for project deletion.
         */
        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            projectIndexToDelete = -1;
        }

        /**
         * Shows the create folder modal.
         */
        function showCreateFolderModal() {
            newFolderNameInput.value = ''; // Clear previous input
            createFolderModal.classList.remove('hidden');
            newFolderNameInput.focus(); // Focus on the input field
        }

        /**
         * Hides the create folder modal.
         */
        function hideCreateFolderModal() {
            createFolderModal.classList.add('hidden');
        }

        /**
         * Shows the delete folder confirmation modal.
         * @param {string} name - The name of the folder to delete.
         */
        function showDeleteFolderModal(name) {
            folderToDeleteName = name;
            folderToDeleteNameSpan.textContent = name;
            deleteFolderModal.classList.remove('hidden');
        }

        /**
         * Hides the delete folder confirmation modal.
         */
        function hideDeleteFolderModal() {
            deleteFolderModal.classList.add('hidden');
            folderToDeleteName = '';
        }

        /**
         * Shows a general message modal with customizable text and buttons.
         * @param {string} message - The text to display in the modal.
         * @param {boolean} showConfirm - Whether to show the confirm button.
         * @param {function} onConfirm - Callback function if confirm is clicked.
         * @param {function} onCancel - Callback function if cancel/okay is clicked.
         * @param {string} confirmText - Text for the confirm button.
         * @param {string} cancelText - Text for the cancel/okay button.
         */
        function showMessageModal(message, showConfirm = false, onConfirm = null, onCancel = null, confirmText = 'Confirm', cancelText = 'Okay') {
            messageModalText.textContent = message;
            messageModalConfirmBtn.textContent = confirmText;
            messageModalCancelBtn.textContent = cancelText;

            if (showConfirm) {
                messageModalConfirmBtn.classList.remove('hidden');
                messageModalConfirmBtn.onclick = () => {
                    hideMessageModal();
                    if (onConfirm) onConfirm();
                };
                messageModalCancelBtn.onclick = () => {
                    hideMessageModal();
                    if (onCancel) onCancel();
                };
            } else {
                messageModalConfirmBtn.classList.add('hidden');
                messageModalCancelBtn.onclick = () => {
                    hideMessageModal();
                    if (onCancel) onCancel();
                };
            }
            messageModal.classList.remove('hidden');
        }

        /**
         * Hides the general message modal.
         */
        function hideMessageModal() {
            messageModal.classList.add('hidden');
            // Clear click handlers to prevent memory leaks or unintended behavior
            messageModalConfirmBtn.onclick = null;
            messageModalCancelBtn.onclick = null;
        }


        /**
         * Loads data (projects and folders) from localStorage.
         */
        function loadData() {
            const storedProjects = localStorage.getItem('creatorLabProjects');
            const storedFolders = localStorage.getItem('creatorLabFolders');

            try {
                projects = storedProjects ? JSON.parse(storedProjects) : [];
                // Ensure all existing projects have a folder property and an ID
                projects.forEach(project => {
                    if (!project.folder) {
                        project.folder = 'Uncategorized';
                    }
                    if (project.id === undefined) {
                        project.id = Date.now() + Math.random(); // Assign a unique ID
                    }
                });

                folders = storedFolders ? JSON.parse(storedFolders) : ['All Projects', 'Uncategorized'];
                // Ensure default folders are always present and at the beginning
                if (!folders.includes('All Projects')) {
                    folders.unshift('All Projects');
                }
                if (!folders.includes('Uncategorized')) {
                    const allIndex = folders.indexOf('All Projects');
                    if (allIndex !== -1) {
                        folders.splice(allIndex + 1, 0, 'Uncategorized');
                    } else {
                        folders.push('Uncategorized');
                    }
                }
                // Filter out duplicates and ensure "All Projects" and "Uncategorized" are first
                folders = [...new Set(folders.filter(f => f !== 'All Projects' && f !== 'Uncategorized'))];
                folders.unshift('Uncategorized');
                folders.unshift('All Projects');


            } catch (e) {
                console.error("Error parsing data from localStorage:", e);
                projects = [];
                folders = ['All Projects', 'Uncategorized'];
            }
            populateAllDropdowns(); // Populate all filter and form dropdowns
            displayProjects(); // Display projects based on initial filters
            showPage('project-list-page');
        }

        /**
         * Saves the current projects array to localStorage.
         */
        function saveProjects() {
            localStorage.setItem('creatorLabProjects', JSON.stringify(projects));
        }

        /**
         * Saves the current folders array to localStorage.
         */
        function saveFolders() {
            localStorage.setItem('creatorLabFolders', JSON.stringify(folders));
        }

        /**
         * Populates a single dropdown dynamically. For form dropdowns (add/edit),
         * it adds unique project-based values to the pre-existing HTML options.
         * For filter dropdowns, it clears and rebuilds with "All" option and unique project values.
         * @param {HTMLElement} selectElement - The dropdown element.
         * @param {string} projectKey - The key in the project object (e.g., 'status', 'focusArea').
         * @param {string} allOptionText - Text for the "All" option (if it's a filter).
         * @param {string} currentFilterValue - The currently selected filter value (for filter dropdowns).
         */
        function populateDropdown(selectElement, projectKey, allOptionText, currentFilterValue) {
            const isFilterDropdown = selectElement.id.includes('-filter-');
            const initialOptions = new Set();

            // Store initial HTML options (if any)
            if (!isFilterDropdown) {
                Array.from(selectElement.options).forEach(option => {
                    initialOptions.add(option.value);
                });
            }
            selectElement.innerHTML = ''; // Clear all options before populating

            // Add "All" option for filter dropdowns first
            if (isFilterDropdown) {
                const allOption = document.createElement('option');
                allOption.value = allOptionText;
                allOption.textContent = allOptionText;
                selectElement.appendChild(allOption);
            }

            // Combine unique project values with initial HTML options (if any)
            const combinedOptions = new Set(initialOptions);
            projects.forEach(project => {
                if (project[projectKey] && project[projectKey].trim() !== '') {
                    combinedOptions.add(project[projectKey].trim());
                }
            });

            // Convert to array, sort, and add to dropdown
            Array.from(combinedOptions).sort((a, b) => {
                // Custom sort for statuses to keep "Not Started" first, etc.
                if (projectKey === 'status') {
                    const order = ['Not Started', 'In Progress', 'On Hold', 'Completed'];
                    const aIndex = order.indexOf(a);
                    const bIndex = order.indexOf(b);
                    if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                    if (aIndex !== -1) return -1; // Keep default status at the front
                    if (bIndex !== -1) return 1;
                }
                // Custom sort for difficulty and complexity to keep "Low", "Medium", "High"
                if (projectKey === 'difficultyRating' || projectKey === 'complexity') {
                    const order = ['', 'Low', 'Medium', 'High'];
                     const aIndex = order.indexOf(a);
                    const bIndex = order.indexOf(b);
                    if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                    if (aIndex !== -1) return -1;
                    if (bIndex !== -1) return 1;
                }
                return a.localeCompare(b);
            }).forEach(value => {
                if (value === '' && !isFilterDropdown) {
                    // Only add empty option for forms if it's explicitly a "Select..." placeholder
                    // or if it was already present in HTML. We don't want dynamic empty options.
                    if (selectElement.options.length > 0 && selectElement.options[0].value === '') {
                        // Already has a "Select..." placeholder, skip adding another empty
                    } else if (initialOptions.has('')) {
                        // Was initially present in HTML, keep it.
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = (projectKey === 'focusArea' || projectKey === 'difficultyRating' || projectKey === 'complexity') ? 'Select ' + projectKey.replace(/([A-Z])/g, ' $1').trim() : value;
                        selectElement.appendChild(option);
                    }
                    return;
                }
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                selectElement.appendChild(option);
            });

            // Set the selected value for filter dropdowns
            if (isFilterDropdown) {
                 selectElement.value = currentFilterValue;
            }
        }


        /**
         * Populates all filter dropdowns (folder, status, focus area, difficulty, complexity)
         * and the add/edit project dropdowns based on existing project data and default options.
         */
        function populateAllDropdowns() {
            // Populate Folder Filter Select
            folderFilterSelect.innerHTML = ''; // Clear existing options
            folders.forEach(folderName => {
                const option = document.createElement('option');
                option.value = folderName;
                option.textContent = folderName;
                folderFilterSelect.appendChild(option);
            });
            folderFilterSelect.value = currentFolderFilter;

            // Populate Add/Edit Project Folder Selects (Folder options are specific and not dynamically from project data)
            addProjectFolderSelect.innerHTML = '';
            editProjectFolderSelect.innerHTML = '';
            folders.forEach(folderName => {
                if (folderName !== 'All Projects') { // 'All Projects' is a filter, not a selectable folder
                    const addOption = document.createElement('option');
                    addOption.value = folderName;
                    addOption.textContent = folderName;
                    addProjectFolderSelect.appendChild(addOption);

                    const editOption = document.createElement('option');
                    editOption.value = folderName;
                    editOption.textContent = folderName;
                    editProjectFolderSelect.appendChild(editOption);
                }
            });
            // Default select for add form if no folder is set
            if (addProjectPage.classList.contains('hidden') === false) {
                 addProjectFolderSelect.value = 'Uncategorized';
            }


            // Populate dynamic dropdowns (filters and add/edit forms)
            populateDropdown(statusFilterSelect, 'status', 'All Statuses', currentStatusFilter);
            populateDropdown(addProjectStatusInput, 'status', null, null);
            populateDropdown(editProjectStatusInput, 'status', null, null);

            populateDropdown(focusAreaFilterSelect, 'focusArea', 'All Focus Areas', currentFocusAreaFilter);
            populateDropdown(addFocusAreaInput, 'focusArea', null, null);
            populateDropdown(editFocusAreaInput, 'focusArea', null, null);

            populateDropdown(difficultyRatingFilterSelect, 'difficultyRating', 'All Difficulties', currentDifficultyFilter);
            populateDropdown(addDifficultyRatingInput, 'difficultyRating', null, null);
            populateDropdown(editDifficultyRatingInput, 'difficultyRating', null, null);

            populateDropdown(complexityFilterSelect, 'complexity', 'All Complexities', currentComplexityFilter);
            populateDropdown(addComplexityInput, 'complexity', null, null);
            populateDropdown(editComplexityInput, 'complexity', null, null);
        }


        /**
         * Handles creating a new folder from the modal input.
         */
        function handleCreateFolder() {
            const folderName = newFolderNameInput.value.trim();
            if (folderName) { // Check if the folder name is not empty after trimming
                if (folderName !== 'All Projects' && folderName !== 'Uncategorized') {
                    if (!folders.includes(folderName)) {
                        folders.push(folderName);
                        saveFolders();
                        populateAllDropdowns(); // Re-populate to update dropdowns
                        hideCreateFolderModal();
                    } else {
                        showMessageModal("Folder already exists!", false, null, null, null, 'Okay');
                    }
                } else {
                    showMessageModal("Folder name cannot be 'All Projects' or 'Uncategorized'.", false, null, null, null, 'Okay');
                }
            } else {
                showMessageModal("Folder name cannot be empty.", false, null, null, null, 'Okay');
            }
        }

        /**
         * Handles the confirmation of deleting a folder.
         */
        function deleteFolderConfirmed() {
            if (!folderToDeleteName) return;

            // Remove the folder from the folders array
            folders = folders.filter(f => f !== folderToDeleteName);

            // Move projects from the deleted folder to 'Uncategorized'
            projects.forEach(project => {
                if (project.folder === folderToDeleteName) {
                    project.folder = 'Uncategorized';
                }
            });

            // If the current view was the deleted folder, switch to 'All Projects'
            if (currentFolderFilter === folderToDeleteName) {
                currentFolderFilter = 'All Projects';
            }

            saveFolders();
            saveProjects();
            populateAllDropdowns(); // Refresh folder navigation and dropdowns
            displayProjects(); // Refresh project list
            hideDeleteFolderModal();
        }

        /**
         * Calculates the total cost from an array of cost objects.
         * @param {Array<Object>} costsArray - The array of cost objects.
         * @returns {number} The total calculated cost.
         */
        function calculateTotalCosts(costsArray) {
            return costsArray.reduce((total, item) => total + item.amount, 0);
        }

        /**
         * Displays the costs list for a given array of costs.
         * @param {Array<Object>} costsArray - The array of cost objects to display.
         * @param {HTMLElement} displayElement - The DOM element where costs should be listed.
         * @param {HTMLElement} totalSpanElement - The DOM element to display the total cost.
         * @param {HTMLElement} noCostsMessageElement - The DOM element for the "no costs" message.
         * @param {string} type - 'add' or 'edit' to determine the delete button class (for unique handling)
         */
        function displayCosts(costsArray, displayElement, totalSpanElement, noCostsMessageElement, type) {
            displayElement.innerHTML = ''; // Clear current costs list
            let totalCost = 0;

            if (costsArray.length === 0) {
                noCostsMessageElement.style.display = 'block';
                totalSpanElement.textContent = `$0.00`;
                return;
            } else {
                noCostsMessageElement.style.display = 'none';
            }

            costsArray.forEach((cost, index) => {
                totalCost += cost.amount;

                const costItemDiv = document.createElement('div');
                costItemDiv.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm mb-2 border border-gray-200';
                costItemDiv.innerHTML = `
                    <div class="flex-grow">
                        <span class="font-medium text-gray-800">${cost.description || 'Untitled Cost'}</span>
                    </div>
                    <div class="font-bold text-gray-900 mr-4">$${cost.amount.toFixed(2)}</div>
                    <button data-cost-index="${index}" class="${type}-delete-cost-btn p-1 rounded-full bg-red-100 hover:bg-red-200 text-red-600 hover:text-red-800 transition duration-150 ease-in-out">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                `;
                displayElement.appendChild(costItemDiv);
            });

            totalSpanElement.textContent = `$${totalCost.toFixed(2)}`;

            // Add event listeners for delete cost buttons dynamically
            displayElement.querySelectorAll(`.${type}-delete-cost-btn`).forEach(button => {
                button.addEventListener('click', (event) => {
                    const costIndex = parseInt(event.currentTarget.dataset.costIndex);
                    // Call generic delete function with correct context
                    if (type === 'add') {
                        deleteCostItemFromProject(tempNewProjectCosts, costIndex, addCostsListDisplay, addTotalProjectCostSpan, addNoCostsMessage, 'add');
                    } else if (type === 'edit') {
                        deleteCostItemFromProject(projects[currentEditProjectIndex].projectCosts, costIndex, editCostsListDisplay, editTotalProjectCostSpan, editNoCostsMessage, 'edit');
                    }
                });
            });
        }

        /**
         * Adds a new cost item to the specified project's costs list.
         * @param {Array<Object>} targetCostsArray - The array to add the cost to (e.g., tempNewProjectCosts or project.projectCosts).
         * @param {HTMLElement} descriptionInput - The input field for the cost description.
         * @param {HTMLElement} amountInput - The input field for the cost amount.
         * @param {HTMLElement} displayElement - The DOM element where costs should be listed.
         * @param {HTMLElement} totalSpanElement - The DOM element to display the total cost.
         * @param {HTMLElement} noCostsMessageElement - The DOM element for the "no costs" message.
         * @param {string} type - 'add' or 'edit' for distinguishing delete buttons.
         */
        function addCostItemToProject(targetCostsArray, descriptionInput, amountInput, displayElement, totalSpanElement, noCostsMessageElement, type) {
            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountInput.value);

            if (isNaN(amount) || amount < 0) {
                showMessageModal("Please enter a valid cost amount.", false, null, null, null, 'Okay');
                return;
            }

            const newCost = {
                description: description,
                amount: amount
            };

            targetCostsArray.push(newCost);
            // Only save projects when a project is actually created or edited, not just when a cost is added temporarily.
            // This 'saveProjects' call here might be redundant for 'tempNewProjectCosts' as they are saved with the project.
            // However, it's necessary for 'edit' type to ensure costs are persisted immediately.
            if (type === 'edit') {
                saveProjects();
            }
            displayCosts(targetCostsArray, displayElement, totalSpanElement, noCostsMessageElement, type);
            descriptionInput.value = ''; // Clear description input
            amountInput.value = '0.00'; // Reset amount input
        }

        /**
         * Deletes a cost item from the specified project's costs list.
         * @param {Array<Object>} targetCostsArray - The array to delete the cost from.
         * @param {number} costIndex - The index of the cost to delete.
         * @param {HTMLElement} displayElement - The DOM element where costs are listed.
         * @param {HTMLElement} totalSpanElement - The DOM element to display the total cost.
         * @param {HTMLElement} noCostsMessageElement - The DOM element for the "no costs" message.
         * @param {string} type - 'add' or 'edit' for distinguishing delete buttons.
         */
        function deleteCostItemFromProject(targetCostsArray, costIndex, displayElement, totalSpanElement, noCostsMessageElement, type) {
            targetCostsArray.splice(costIndex, 1);
            if (type === 'edit') {
                saveProjects();
            }
            displayCosts(targetCostsArray, displayElement, totalSpanElement, noCostsMessageElement, type);
        }

        /**
         * Clears all cost input fields for both add and edit forms.
         */
        function clearAllCostInputs() {
            addCostDescriptionInput.value = '';
            addCostAmountInput.value = '0.00';
            editCostDescriptionInput.value = '';
            editCostAmountInput.value = '0.00';
        }


        /**
         * Displays all projects currently in the `projects` array, filtered by `currentFolder`, `currentStatusFilter`,
         * `currentFocusAreaFilter`, and `currentTitleSearch`.
         * Clears the existing list and re-renders everything.
         */
        function displayProjects() {
            projectListDiv.innerHTML = ''; // Clear current list

            const filteredProjects = projects.filter(project => {
                const folderMatch = (currentFolderFilter === 'All Projects') ||
                                    (currentFolderFilter === 'Uncategorized' && (!project.folder || project.folder === 'Uncategorized')) ||
                                    (project.folder === currentFolderFilter);

                const statusMatch = (currentStatusFilter === 'All Statuses') ||
                                    (project.status === currentStatusFilter);

                const focusAreaMatch = (currentFocusAreaFilter === 'All Focus Areas') ||
                                       (project.focusArea === currentFocusAreaFilter);
                
                const difficultyMatch = (currentDifficultyFilter === 'All Difficulties') ||
                                        (project.difficultyRating === currentDifficultyFilter);

                const complexityMatch = (currentComplexityFilter === 'All Complexities') ||
                                        (project.complexity === currentComplexityFilter);

                // Case-insensitive title search
                const titleMatch = project.name.toLowerCase().includes(currentTitleSearch.toLowerCase());

                return folderMatch && statusMatch && focusAreaMatch && difficultyMatch && complexityMatch && titleMatch;
            });

            if (filteredProjects.length === 0) {
                noProjectsMessage.style.display = 'block'; // Show "No projects" message
                // Ensure it's inside projectListDiv if it was removed
                if (!projectListDiv.contains(noProjectsMessage)) {
                    projectListDiv.appendChild(noProjectsMessage);
                }
                updateSelectionCount(); // Update count even if no projects
                return;
            } else {
                noProjectsMessage.style.display = 'none'; // Hide "No projects" message
            }

            // Loop through each filtered project and create its HTML representation
            filteredProjects.forEach((project, index) => {
                const projectCard = document.createElement('div');
                // Apply custom .project-card class for hover effect and more rounded corners
                // Changed cursor back to default as direct card click is now for selection toggle or no action.
                projectCard.className = 'project-card bg-white shadow-md border border-gray-200 relative overflow-hidden flex flex-col max-w-xs w-full aspect-square';
                projectCard.dataset.id = project.id; // Store project ID on the card for selection
                const actualProjectIndex = projects.findIndex(p => p.id === project.id);


                let statusColor = 'bg-gray-200 text-gray-800';
                if (project.status === 'Completed') {
                    statusColor = 'bg-green-100 text-green-700';
                } else if (project.status === 'In Progress') {
                    statusColor = 'bg-blue-100 text-blue-700';
                } else if (project.status === 'On Hold') {
                    statusColor = 'bg-yellow-100 text-yellow-700';
                } else if (project.status === 'Not Started') {
                    statusColor = 'bg-red-100 text-red-700';
                }

                projectCard.innerHTML = `
                    <div class="relative bg-blue-200 h-24 flex items-center justify-center text-center rounded-t-3xl overflow-hidden p-2">
                        <h3 class="text-xl font-bold text-blue-900">${project.name}</h3>
                    </div>
                    <div class="p-3 flex-grow overflow-y-auto">
                        ${project.overview ? `<p class="text-sm text-gray-600 mt-1"><strong>Overview:</strong> ${project.overview}</p>` : ''}
                        
                        <div class="mt-2 text-sm">
                            <span class="font-medium text-gray-700">Folder:</span> <span class="text-gray-600">${project.folder || 'Uncategorized'}</span>
                        </div>
                        <div class="mt-1 text-sm">
                            <span class="font-medium text-gray-700">Due Date:</span> <span class="text-gray-600">${project.dueDate || 'N/A'}</span>
                        </div>
                        <div class="mt-1 text-sm">
                            <span class="font-medium text-gray-700">Status:</span>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                                ${project.status}
                            </span>
                        </div>
                        ${project.focusArea ? `<div class="mt-1 text-sm">
                            <span class="font-medium text-gray-700">Focus Area:</span> <span class="text-gray-600">${project.focusArea}</span>
                        </div>` : ''}
                        ${project.difficultyRating ? `<div class="mt-1 text-sm">
                            <span class="font-medium text-gray-700">Difficulty:</span> <span class="text-gray-600">${project.difficultyRating}</span>
                        </div>` : ''}
                        ${project.complexity ? `<div class="mt-1 text-sm">
                            <span class="font-medium text-gray-700">Complexity:</span> <span class="text-gray-600">${project.complexity}</span>
                        </div>` : ''}
                        ${(project.projectCosts && project.projectCosts.length > 0) ? `<div class="mt-2 text-sm">
                            <span class="font-medium text-gray-700">Total Cost:</span> <span class="text-gray-600">$${calculateTotalCosts(project.projectCosts).toFixed(2)}</span>
                        </div>` : ''}
                    </div>
                    <div class="absolute top-3 right-3 flex space-x-2">
                        <!-- Checkbox for selection (hidden by default) -->
                        <input type="checkbox" data-project-id="${project.id}" class="project-checkbox form-checkbox h-5 w-5 text-blue-600 rounded hidden">
                        <!-- New Edit Button -->
                        <button data-index="${actualProjectIndex}" class="edit-btn p-1 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.827-2.828z" />
                            </svg>
                        </button>
                        <!-- Delete Button -->
                        <button data-index="${actualProjectIndex}" class="delete-btn p-1 rounded-full bg-red-100 hover:bg-red-200 text-red-600 hover:text-red-800 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                projectListDiv.appendChild(projectCard);
            });

            // Add event listener to the whole card for editing
            document.querySelectorAll('.project-card').forEach(card => {
                const projectId = parseInt(card.dataset.id);
                const checkbox = card.querySelector('.project-checkbox');
                const editButton = card.querySelector('.edit-btn'); // Get the new edit button
                const deleteButton = card.querySelector('.delete-btn'); // Get the delete button

                // Ensure checkbox state is correct when initially displayed
                if (isSelectionMode) {
                    checkbox.classList.remove('hidden');
                    checkbox.checked = selectedProjectIds.has(projectId);
                } else {
                    checkbox.classList.add('hidden');
                    checkbox.checked = false; // Ensure unchecked when not in selection mode
                }

                // Handle clicks on the checkbox specifically
                checkbox.onclick = (event) => {
                    event.stopPropagation(); // Prevent this click from bubbling to the card
                    if (checkbox.checked) {
                        selectedProjectIds.add(projectId);
                    } else {
                        selectedProjectIds.delete(projectId);
                    }
                    updateSelectionCount();
                };

                // Handle clicks on the NEW Edit button specifically
                editButton.onclick = (event) => {
                    event.stopPropagation(); // Prevent this click from bubbling to the card
                    const indexToEdit = parseInt(event.currentTarget.dataset.index);
                    prepareEditProject(indexToEdit);
                };

                // Handle clicks on the delete button specifically
                deleteButton.onclick = (event) => {
                    event.stopPropagation(); // Prevent this click from bubbling to the card
                    const indexToDelete = parseInt(event.currentTarget.dataset.index);
                    showConfirmationModal(indexToDelete);
                };

                // Handle clicks on the card itself (now primarily for selection mode)
                card.onclick = (event) => {
                    // If in selection mode and the click wasn't on the buttons/checkbox (which stop propagation)
                    if (isSelectionMode) {
                        checkbox.checked = !checkbox.checked; // Toggle visually
                        if (checkbox.checked) {
                            selectedProjectIds.add(projectId);
                        } else {
                            selectedProjectIds.delete(projectId);
                        }
                        updateSelectionCount();
                    }
                    // If not in selection mode, now the card itself does NOT trigger edit.
                    // The edit button handles that.
                };
            });

            updateSelectionCount(); // Initial update after display
        }

        /**
         * Adds a new project based on form input.
         * @param {Event} event - The form submission event.
         */
        function addProject(event) {
            event.preventDefault();

            const selectedFolder = addProjectFolderSelect.value.trim();

            const newProject = {
                id: Date.now() + Math.random(), // Use a more robust unique ID
                name: addProjectNameInput.value.trim(),
                overview: addProjectOverviewInput.value.trim(),
                description: addProjectDescriptionInput.value.trim(),
                dueDate: addDueDateInput.value,
                status: addProjectStatusInput.value,
                folder: selectedFolder || 'Uncategorized', // Default to Uncategorized if empty
                codeNotes: addCodeNotesInput.value.trim(),
                cadNotes: addCadNotesInput.value.trim(),
                materialNotes: addMaterialNotesInput.value.trim(),
                focusArea: addFocusAreaInput.value,
                difficultyRating: addDifficultyRatingInput.value,
                complexity: addComplexityInput.value,
                projectCosts: [...tempNewProjectCosts] // Assign the temporary costs to the new project
            };

            if (!newProject.name) {
                showMessageModal('Project Name cannot be empty!', false, null, null, null, 'Okay');
                return;
            }

            projects.push(newProject);
            saveProjects();
            populateAllDropdowns(); // Update all dropdowns after adding a new project
            displayProjects();
            addProjectForm.reset();
            tempNewProjectCosts = []; // Clear temporary costs after saving
            displayCosts(tempNewProjectCosts, addCostsListDisplay, addTotalProjectCostSpan, addNoCostsMessage, 'add'); // Reset add costs display
            showPage('project-list-page');
        }

        /**
         * Prepares the edit form with the selected project's data and shows the edit page.
         * @param {number} index - The index of the project to edit.
         */
        function prepareEditProject(index) {
            currentEditProjectIndex = index;
            const projectToEdit = projects[index];
            if (projectToEdit) {
                editProjectIndexInput.value = index;
                editProjectNameInput.value = projectToEdit.name;
                editProjectOverviewInput.value = projectToEdit.overview || '';
                editProjectDescriptionInput.value = projectToEdit.description || '';
                editDueDateInput.value = projectToEdit.dueDate;
                editCodeNotesInput.value = projectToEdit.codeNotes || '';
                editCadNotesInput.value = projectToEdit.cadNotes || '';
                editMaterialNotesInput.value = projectToEdit.materialNotes || '';
                editFocusAreaInput.value = projectToEdit.focusArea || '';
                editDifficultyRatingInput.value = projectToEdit.difficultyRating || '';
                editComplexityInput.value = projectToEdit.complexity || '';
                
                // Populate all dropdowns (including edit form ones)
                // This ensures any newly created dynamic options are available
                populateAllDropdowns();

                // Explicitly set the values for edit forms after repopulation
                editProjectFolderSelect.value = projectToEdit.folder || 'Uncategorized';
                editProjectStatusInput.value = projectToEdit.status; // Explicitly set value after repopulation
                editFocusAreaInput.value = projectToEdit.focusArea || '';
                editDifficultyRatingInput.value = projectToEdit.difficultyRating || '';
                editComplexityInput.value = projectToEdit.complexity || '';


                projectToEdit.projectCosts = projectToEdit.projectCosts || [];
                displayCosts(projectToEdit.projectCosts, editCostsListDisplay, editTotalProjectCostSpan, editNoCostsMessage, 'edit');
                clearAllCostInputs(); // Clear all inputs, including add page's
                showPage('edit-project-page'); // Show the edit page
            }
        }

        /**
         * Saves changes made to a project in the edit form.
         * @param {Event} event - The form submission event.
         */
        function saveEditedProject(event) {
            event.preventDefault();

            const index = parseInt(editProjectIndexInput.value);
            if (index > -1 && index < projects.length) {
                const selectedFolder = editProjectFolderSelect.value.trim();

                projects[index].name = editProjectNameInput.value.trim();
                projects[index].overview = editProjectOverviewInput.value.trim();
                projects[index].description = editProjectDescriptionInput.value.trim();
                projects[index].dueDate = editDueDateInput.value;
                projects[index].status = editProjectStatusInput.value;
                projects[index].folder = selectedFolder || 'Uncategorized'; // Save selected folder
                projects[index].codeNotes = editCodeNotesInput.value.trim();
                projects[index].cadNotes = editCadNotesInput.value.trim();
                projects[index].materialNotes = editMaterialNotesInput.value.trim();
                projects[index].focusArea = editFocusAreaInput.value;
                projects[index].difficultyRating = editDifficultyRatingInput.value;
                projects[index].complexity = editComplexityInput.value;

                if (!projects[index].name) {
                    showMessageModal('Project Name cannot be empty!', false, null, null, null, 'Okay');
                    return;
                }

                saveProjects();
                populateAllDropdowns(); // Update all dynamic filter dropdowns
                displayProjects();
                showPage('project-list-page');
            }
        }

        /**
         * Toggles the selection mode for projects.
         */
        function toggleSelectionMode() {
            isSelectionMode = !isSelectionMode;
            if (isSelectionMode) {
                toggleSelectionBtn.textContent = 'Done Selecting';
                exportProjectsBtn.textContent = 'Export Selected Projects';
                selectionActionsDiv.classList.remove('hidden');
            } else {
                toggleSelectionBtn.textContent = 'Select Projects';
                exportProjectsBtn.textContent = 'Export All Projects';
                selectionActionsDiv.classList.add('hidden');
                selectedProjectIds.clear(); // Clear selections when exiting mode
            }
            displayProjects(); // Re-render to show/hide checkboxes and update counts
        }

        /**
         * Selects all projects currently displayed in the filtered list.
         */
        function selectAllProjects() {
            // Get currently filtered projects to select only those visible
            const filteredProjects = projects.filter(project => {
                const folderMatch = (currentFolderFilter === 'All Projects') ||
                                    (currentFolderFilter === 'Uncategorized' && (!project.folder || project.folder === 'Uncategorized')) ||
                                    (project.folder === currentFolderFilter);

                const statusMatch = (currentStatusFilter === 'All Statuses') ||
                                    (project.status === currentStatusFilter);

                const focusAreaMatch = (currentFocusAreaFilter === 'All Focus Areas') ||
                                       (project.focusArea === currentFocusAreaFilter);
                
                const difficultyMatch = (currentDifficultyFilter === 'All Difficulties') ||
                                        (project.difficultyRating === currentDifficultyFilter);

                const complexityMatch = (currentComplexityFilter === 'All Complexities') ||
                                        (project.complexity === currentComplexityFilter);

                const titleMatch = project.name.toLowerCase().includes(currentTitleSearch.toLowerCase());

                return folderMatch && statusMatch && focusAreaMatch && difficultyMatch && complexityMatch && titleMatch;
            });

            selectedProjectIds.clear();
            filteredProjects.forEach(project => {
                selectedProjectIds.add(project.id);
            });
            displayProjects(); // Re-render to update checkboxes
        }

        /**
         * Deselects all projects.
         */
        function deselectAllProjects() {
            selectedProjectIds.clear();
            displayProjects(); // Re-render to update checkboxes
        }

        /**
         * Updates the displayed count of selected projects.
         */
        function updateSelectionCount() {
            selectedCountSpan.textContent = selectedProjectIds.size;
        }

        /**
         * Exports projects to a JSON file. Exports selected if in selection mode, otherwise all.
         */
        function exportProjects() {
            let projectsToExport = [];
            if (isSelectionMode && selectedProjectIds.size > 0) {
                projectsToExport = projects.filter(project => selectedProjectIds.has(project.id));
            } else if (isSelectionMode && selectedProjectIds.size === 0) {
                showMessageModal('No projects selected for export.', false, null, null, null, 'Okay');
                return;
            } else {
                projectsToExport = projects; // Export all if not in selection mode or no projects selected
            }

            if (projectsToExport.length === 0) {
                showMessageModal('No projects to export.', false, null, null, null, 'Okay');
                return;
            }

            const dataStr = JSON.stringify(projectsToExport, null, 2); // Pretty print JSON
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `creatorlab_projects_${new Date().toISOString().slice(0,10)}.json`; // Dynamic filename
            document.body.appendChild(a); // Append to body to make it clickable in some browsers
            a.click();
            document.body.removeChild(a); // Clean up
            URL.revokeObjectURL(url); // Release the object URL
            showMessageModal('Projects exported successfully!', false, null, null, null, 'Okay');
            
            if (isSelectionMode) {
                 // Exit selection mode after successful export of selected projects
                toggleSelectionMode();
            }
        }

        /**
         * Imports projects from a selected JSON file.
         */
        function importProjects(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // Basic validation: Check if it's an array
                    if (Array.isArray(importedData)) {
                        showMessageModal(
                            'Importing projects will replace all existing projects. Are you sure?',
                            true, // Show confirm button
                            () => { // On Confirm
                                projects = importedData;
                                // Ensure all imported projects have an ID
                                projects.forEach(project => {
                                    if (project.id === undefined) {
                                        project.id = Date.now() + Math.random();
                                    }
                                    if (!project.folder) { // Ensure imported projects have a folder
                                        project.folder = 'Uncategorized';
                                    }
                                });
                                saveProjects();
                                // Rebuild folders and focus areas based on imported projects
                                const newFolders = new Set(['All Projects', 'Uncategorized']);
                                projects.forEach(p => {
                                    if (p.folder) newFolders.add(p.folder);
                                });
                                folders = Array.from(newFolders);
                                folders = folders.filter(f => f !== 'All Projects' && f !== 'Uncategorized');
                                folders.unshift('Uncategorized');
                                folders.unshift('All Projects');
                                saveFolders();

                                // Reset filters to default after import
                                currentFolderFilter = 'All Projects';
                                currentStatusFilter = 'All Statuses';
                                currentFocusAreaFilter = 'All Focus Areas';
                                currentDifficultyFilter = 'All Difficulties';
                                currentComplexityFilter = 'All Complexities';
                                currentTitleSearch = '';
                                titleSearchInput.value = ''; // Clear search input


                                populateAllDropdowns(); // Re-populate all dropdowns
                                displayProjects();
                                showMessageModal('Projects imported successfully!', false, null, null, null, 'Okay');
                            },
                            () => { // On Cancel
                                showMessageModal('Import cancelled.', false, null, null, null, 'Okay');
                            },
                            'Yes, Replace All',
                            'No, Keep Current'
                        );
                    } else {
                        showMessageModal('Invalid JSON file format. Please select a file containing a list of projects.', false, null, null, null, 'Okay');
                    }
                } catch (error) {
                    console.error('Error parsing imported file:', error);
                    showMessageModal('Failed to read or parse the project file. Please ensure it is a valid JSON file.', false, null, null, null, 'Okay');
                } finally {
                    // Reset the file input to allow selecting the same file again if needed
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        // Event Listeners for navigation and form submissions
        showAddBtn.addEventListener('click', () => {
            addProjectForm.reset();
            addProjectFolderSelect.value = 'Uncategorized'; // Set default folder for new projects
            tempNewProjectCosts = []; // Clear temporary costs for new project
            displayCosts(tempNewProjectCosts, addCostsListDisplay, addTotalProjectCostSpan, addNoCostsMessage, 'add'); // Display empty costs for new project
            clearAllCostInputs(); // Clear all inputs, including edit page's
            populateAllDropdowns(); // Ensure add form dropdowns are updated with latest dynamic options
            showPage('add-project-page');
        });
        backToListFromAddBtn.addEventListener('click', () => showPage('project-list-page'));
        backToListFromEditBtn.addEventListener('click', () => {
            currentEditProjectIndex = -1;
            showPage('project-list-page');
        });

        // Event listener for the create folder button
        createFolderBtn.addEventListener('click', showCreateFolderModal);

        // Event listeners for the new "Create Folder" modal
        confirmCreateFolderBtn.addEventListener('click', handleCreateFolder);
        cancelCreateFolderBtn.addEventListener('click', hideCreateFolderModal);
        newFolderNameInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission if input is within a form
                handleCreateFolder();
            }
        });

        // Event listeners for the new "Delete Folder" modal
        confirmDeleteFolderBtn.addEventListener('click', deleteFolderConfirmed);
        cancelDeleteFolderBtn.addEventListener('click', hideDeleteFolderModal);


        // Event Listeners for Add Project Costs
        addAddCostBtn.addEventListener('click', () => {
            addCostItemToProject(tempNewProjectCosts, addCostDescriptionInput, addCostAmountInput, addCostsListDisplay, addTotalProjectCostSpan, addNoCostsMessage, 'add');
        });

        // Event listeners for Edit Project Costs
        editAddCostBtn.addEventListener('click', () => {
            addCostItemToProject(projects[currentEditProjectIndex].projectCosts, editCostDescriptionInput, editCostAmountInput, editCostsListDisplay, editTotalProjectCostSpan, editNoCostsMessage, 'edit');
        });

        addProjectForm.addEventListener('submit', addProject);
        editProjectForm.addEventListener('submit', saveEditedProject);

        // Event Listeners for project confirmation modal (for deleting a project)
        confirmDeleteBtn.addEventListener('click', () => {
            if (projectIndexToDelete > -1 && projectIndexToDelete < projects.length) {
                projects.splice(projectIndexToDelete, 1);
                saveProjects();
                populateAllDropdowns(); // Update dropdowns after delete
                displayProjects();
                hideConfirmationModal();
            }
        });
        cancelDeleteBtn.addEventListener('click', hideConfirmationModal);


        // Event Listeners for Import/Export and Selection buttons
        toggleSelectionBtn.addEventListener('click', toggleSelectionMode);
        exportProjectsBtn.addEventListener('click', exportProjects);
        importProjectsBtn.addEventListener('click', () => {
            importProjectsInput.click(); // Trigger the hidden file input click
        });
        importProjectsInput.addEventListener('change', importProjects);
        selectAllBtn.addEventListener('click', selectAllProjects);
        deselectAllBtn.addEventListener('click', deselectAllProjects);

        // Event listeners for Filter Dropdowns and Search
        folderFilterSelect.addEventListener('change', (event) => {
            currentFolderFilter = event.target.value;
            displayProjects();
        });

        statusFilterSelect.addEventListener('change', (event) => {
            currentStatusFilter = event.target.value;
            displayProjects();
        });

        focusAreaFilterSelect.addEventListener('change', (event) => {
            currentFocusAreaFilter = event.target.value;
            displayProjects();
        });

        // New event listeners for Difficulty and Complexity filters
        difficultyRatingFilterSelect.addEventListener('change', (event) => {
            currentDifficultyFilter = event.target.value;
            displayProjects();
        });

        complexityFilterSelect.addEventListener('change', (event) => {
            currentComplexityFilter = event.target.value;
            displayProjects();
        });

        titleSearchInput.addEventListener('keyup', (event) => {
            currentTitleSearch = event.target.value;
            displayProjects();
        });


        // Load data when the page first loads
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
